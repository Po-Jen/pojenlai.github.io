<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Yen</title>
    <description>This blog talks about how to make machine learn.
</description>
    <link>http://yclin.me/</link>
    <atom:link href="http://yclin.me/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Tue, 19 Jul 2016 16:43:48 +0800</pubDate>
    <lastBuildDate>Tue, 19 Jul 2016 16:43:48 +0800</lastBuildDate>
    <generator>Jekyll v3.1.2</generator>
    
      <item>
        <title>Using Function Pointer to Maximize Code Reusability in Cython</title>
        <description>&lt;p&gt;When writing C, function pointer is extremely useful because it can help us define a &lt;strong&gt;callback&lt;/strong&gt; function, i.e., &lt;strong&gt;a way to parametrize a function&lt;/strong&gt;. This means that some part of the function behavior is not hard-coded into itself, but into the callback function provided by user. Callers can make function behave differently by passing different callback functions. A classic example is &lt;code class=&quot;highlighter-rouge&quot;&gt;qsort()&lt;/code&gt; from the C standard library that takes its sorting criterion as a pointer to a comparison function.&lt;/p&gt;

&lt;p&gt;Besides the benefit above, we can also use function pointer straightforwardly to avoid redundant control flow code such as &lt;code class=&quot;highlighter-rouge&quot;&gt;if&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;else&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;In this blog post, I’m going to explain how we can combine function pointer and Cython fused types in a easy way to make function pointer become more powerful than ever, and therefore maximize the code reusability in Cython.&lt;/p&gt;

&lt;h2 id=&quot;function-pointer&quot;&gt;Function Pointer&lt;/h2&gt;

&lt;p&gt;Let’s start from why function pointer can help us address code duplication issue.&lt;/p&gt;

&lt;p&gt;Consider we have the following two functions, one add one and the other add two to the function argument:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;add_one&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;add_two&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Now close your eyes, try your best to imagine the operation &lt;code class=&quot;highlighter-rouge&quot;&gt;x+1&lt;/code&gt; performed in &lt;code class=&quot;highlighter-rouge&quot;&gt;add_one&lt;/code&gt; and the operation &lt;code class=&quot;highlighter-rouge&quot;&gt;x+2&lt;/code&gt; performed in &lt;code class=&quot;highlighter-rouge&quot;&gt;add_two&lt;/code&gt; are costly which must be implemented in C or they will take several hours to complete.&lt;/p&gt;

&lt;p&gt;Okay, base on the &lt;del&gt;imagined&lt;/del&gt; reason above, we indeed need to import C funcitons above to speed up our Cython function, which will return &lt;code class=&quot;highlighter-rouge&quot;&gt;(x+1)*2+1&lt;/code&gt; if &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt; is an odd number, or &lt;code class=&quot;highlighter-rouge&quot;&gt;(x+2)*2+2&lt;/code&gt; if &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt; is an even number:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;linear_transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;
	This function will return (x+1)*2+1 if x is odd
	                          (x+2)*2+2 if x is even
	&quot;&quot;&quot;&lt;/span&gt;
	
	&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# x is odd&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;          &lt;span class=&quot;c&quot;&gt;# x is even&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_two&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
	
	&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Code&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;duplication&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_two&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;As one can see, there is a code duplication appears in the end of this function, because we have to check whether we need to apply &lt;code class=&quot;highlighter-rouge&quot;&gt;add_one&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;add_two&lt;/code&gt; to the variable &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To address this issue, we can definine a function pointer and assign it once we know &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt; is a odd number or even number. Until the end of the program, we don’t have to write annoying &lt;code class=&quot;highlighter-rouge&quot;&gt;if&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;else&lt;/code&gt; again.&lt;/p&gt;

&lt;p&gt;Above code snippet can reduce to:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ctypedef&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;linear_transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;
	This function will return (x+1)*2+1 if x is odd
	                          (x+2)*2+2 if x is even
	&quot;&quot;&quot;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ADD&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# x is odd&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;          &lt;span class=&quot;c&quot;&gt;# x is even&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_two&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This code snippet is more readable. Function pointer do make our code looks neat!&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: Although there is only one duplication in above example, there may be a lot in real code, which can show function pointer’s value more obviously.&lt;/p&gt;

&lt;h2 id=&quot;function-pointers-limitation&quot;&gt;Function Pointer’s Limitation&lt;/h2&gt;

&lt;p&gt;However, function pointer is not omnipotent. Although they provide a good way to write generic code, unfortunately they don’t provide you with &lt;strong&gt;type generality&lt;/strong&gt;. What do I mean?&lt;/p&gt;

&lt;p&gt;Consider if we now have the following two C functions that both add 1 to the argument variable, one is for type &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; and one is for type &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;add_one_float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;float&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;add_one_double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Now do the imagination process described in our first example again, base on the same reason, we indeed need to load these extern C functions to speed up the following Cython function &lt;code class=&quot;highlighter-rouge&quot;&gt;linear_transform &lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;linear_transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;
	This function will return (x+1)*2+1 with the 
	same type as input argument
	&quot;&quot;&quot;&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Don’t be scared if you havn’t seem &lt;code class=&quot;highlighter-rouge&quot;&gt;floating&lt;/code&gt; before, to be brief, &lt;code class=&quot;highlighter-rouge&quot;&gt;floating&lt;/code&gt; here refers to either type &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; &lt;strong&gt;or&lt;/strong&gt; type &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt;.
It is just a feature called &lt;a href=&quot;http://docs.cython.org/src/userguide/fusedtypes.html&quot;&gt;fused types&lt;/a&gt; in Cython, which basically serves the same role like templates in C++ or generics in Java.&lt;/p&gt;

&lt;p&gt;Note that now we can’t define a function pointer and assign it like what we did in our first example, because C functions &lt;code class=&quot;highlighter-rouge&quot;&gt;add_one_float&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;add_one_double&lt;/code&gt; have different function signatures. Since C is a strong typed language, it’s hard to define a function pointer that can point to functions with different types. (which is why, for example, the standard library &lt;code class=&quot;highlighter-rouge&quot;&gt;qsort&lt;/code&gt; still requires a function that takes &lt;code class=&quot;highlighter-rouge&quot;&gt;void*&lt;/code&gt; pointer.)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: Usage of &lt;code class=&quot;highlighter-rouge&quot;&gt;void*&lt;/code&gt; pointer in C is beyond the scope of this blog post, you can find a simple introduction &lt;a href=&quot;http://www.circuitstoday.com/void-pointers-in-c&quot;&gt;here&lt;/a&gt;. But remember, it’s dangerous.&lt;/p&gt;

&lt;h2 id=&quot;finction-pointer--fused-types&quot;&gt;Finction Pointer + Fused Types&lt;/h2&gt;

&lt;p&gt;Fortunately, &lt;a href=&quot;http://docs.cython.org/src/userguide/fusedtypes.html&quot;&gt;fused types&lt;/a&gt; is here to rescue us. With this useful tool, we can actually define fused types function pointer to solve above problem!&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ctypedef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ADD&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;linear_transform&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;
	This function will return (x+1)*2+1 with the 
	same type as input argument
	&quot;&quot;&quot;&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;ADD&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_float&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;elif&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_double&lt;/span&gt;
		
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# (x+1)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;         &lt;span class=&quot;c&quot;&gt;# (x+1)*2&lt;/span&gt;
	
	&lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# (x+1)*2+1&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ans&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Note that since &lt;code class=&quot;highlighter-rouge&quot;&gt;floating&lt;/code&gt; can represent either &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt;, function pointer of type &lt;code class=&quot;highlighter-rouge&quot;&gt;floating&lt;/code&gt; have the ability to achieve &lt;strong&gt;type generality&lt;/strong&gt;, which is not available before we combine fused types with function pointer.&lt;/p&gt;

&lt;p&gt;Finally, we are going to demystify the secret of this magic trick performed by Cython and make sure that it works properly.&lt;/p&gt;

&lt;h2 id=&quot;demystifying-how-it-work&quot;&gt;Demystifying How It Work&lt;/h2&gt;

&lt;p&gt;In order to know how Cython fused types function pointer works, let’s become a ninja and dive deep to peep the C code generated by Cython.&lt;/p&gt;

&lt;p&gt;In the generated C code of above Cython function, there is no &lt;code class=&quot;highlighter-rouge&quot;&gt;if floating is float:&lt;/code&gt; anymore. Actually, to accommodate fused types &lt;code class=&quot;highlighter-rouge&quot;&gt;floating&lt;/code&gt;, Cython generates one version of the function for &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; and another for &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;And in the &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; version function, it directly assign the function pointer we declared to the actual C function that will be called if &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt; is of type &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;__pyx_v_add_one&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_float&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Same as the &lt;code class=&quot;highlighter-rouge&quot;&gt;float&lt;/code&gt; version, &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt; version also generates&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;	&lt;span class=&quot;n&quot;&gt;__pyx_v_add_one&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;add_one_double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;which directly assigns function pointer to the correct function.&lt;/p&gt;

&lt;p&gt;In fact, this direct assignment is an optimization performed by C compiler since it can identify variables that remain unchanged within a function. It would find out that function pointer &lt;code class=&quot;highlighter-rouge&quot;&gt;__pyx_v_add_one&lt;/code&gt; is only set once to a constant, i.e., an extern function. Hence after object code is linked, &lt;code class=&quot;highlighter-rouge&quot;&gt;__pyx_v_add_one &lt;/code&gt; will directly be assigned to the C function.&lt;/p&gt;

&lt;p&gt;On the contrary, Python interpreter can provides only little in static analysis and code optimization since the language design doesn’t have the &lt;em&gt;compile&lt;/em&gt; phase.&lt;/p&gt;

&lt;p&gt;In sum, always implement your computation heavy code in Cython instead of Python.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Combining function pointer with fused types raises its power to another higher level. Actually, it is a generalized version of original function pointers, and can be used in lots of places to make our code looks more readable and cleaner.
Also, it is often a good idea to check the C code generated by Cython so as to make sure it’s doing what you hoped.&lt;/p&gt;

&lt;p&gt;See you next time!&lt;/p&gt;
</description>
        <pubDate>Mon, 18 Jul 2016 07:52:21 +0800</pubDate>
        <link>http://yclin.me/2016/07/Function-Pointer</link>
        <guid isPermaLink="true">http://yclin.me/2016/07/Function-Pointer</guid>
        
        
        <category>GSoC</category>
        
      </item>
    
      <item>
        <title>scikit-learn KMeans Now Support Fused Types</title>
        <description>&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Cluster_analysis&quot;&gt;Clustering&lt;/a&gt; is the task of grouping a set of objects in such a way that objects in the same group (called a cluster) are more similar to each other than to those in other groups (clusters). This common technique is used in many fields, including image analysis and unsupervised document classification. In scikit-learn, clustering of unlabeled data can be performed with the module &lt;a href=&quot;http://scikit-learn.org/stable/modules/classes.html#module-sklearn.cluster&quot;&gt;sklearn.cluster&lt;/a&gt;. However, in the current implementation of scikit-learn, one of the most popular clustering algorithm, KMeans, only support &lt;code class=&quot;highlighter-rouge&quot;&gt;float64&lt;/code&gt; input data and will therefore implicitly convert other input data types, e.g., &lt;code class=&quot;highlighter-rouge&quot;&gt;float32&lt;/code&gt;, into &lt;code class=&quot;highlighter-rouge&quot;&gt;float64&lt;/code&gt;, which may cause seriously memory waste.&lt;/p&gt;

&lt;p&gt;Below, I’ll briefly introduce KMeans algorithms and go through the work I’ve done to make it become memory-efficient during GSoC.&lt;/p&gt;

&lt;h2 id=&quot;kmeans&quot;&gt;KMeans&lt;/h2&gt;

&lt;p&gt;KMeans is probably one of the most well-knowned clustering algorithm since it is both effective and easy to be implemented.&lt;/p&gt;

&lt;p&gt;To understand KMeans algorithm, I think it is good to start from these figures which clearly illustrate how KMeans works.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://stanford.edu/~cpiech/cs221/img/kmeansViz.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Training examples are shown as dots, and cluster centroids are shown as crosses.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;(a) Original dataset.&lt;/li&gt;
  &lt;li&gt;(b) Random initial cluster centroids.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;(c-f) Illustration of running two iterations of k-means. In each iteration, we&lt;/p&gt;

    &lt;ol&gt;
      &lt;li&gt;Assign each training example to the closest cluster centroid (shown by “painting” the training examples the same color as the cluster centroid to which is assigned)&lt;/li&gt;
      &lt;li&gt;Move each cluster centroid to the mean of the points assigned to it.&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For more details, &lt;a href=&quot;http://cs229.stanford.edu/notes/cs229-notes7a.pdf&quot;&gt;Andrew Ng’s course note&lt;/a&gt; is a good reference.&lt;/p&gt;

&lt;p&gt;In scikit-learn, &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#k-means&quot;&gt;KMeans&lt;/a&gt; implements the algorithm described above, and &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#mini-batch-k-means&quot;&gt;MiniBatchKMeans&lt;/a&gt; is a variant of the KMeans algorithm which uses mini-batches to reduce the computation time, while still attempting to optimise the same objective function.&lt;/p&gt;

&lt;h2 id=&quot;memory-wasting-issues&quot;&gt;Memory Wasting Issues&lt;/h2&gt;

&lt;p&gt;However, original implementation of these two algorithms in scikit-learn are not memory-efficient, they will convert input data into &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; since Cython implementation only supports &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt; input data.&lt;/p&gt;

&lt;p&gt;Here’s a simple test script which can help us identify the memory wasting issues:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;np&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;scipy&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sparse&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sp&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;sklearn.cluster&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;KMeans&lt;/span&gt;

&lt;span class=&quot;nd&quot;&gt;@profile&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;fit_est&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;estimator&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;seed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;random&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;200000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Toggle the following comment to test `np.float32` data&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# X = np.float32(X)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Toggle the following comment to test sprase data&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# X = sp.csr_matrix(X)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;estimator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;KMeans&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;fit_est&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;You can run&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mprof run &amp;lt;script&amp;gt;
mprof plot
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;to see the memory profiling results.&lt;/p&gt;

&lt;p&gt;To save your effort, below is the result of memory profiling on my own computer:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Dense &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data &amp;amp; Dense &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; data 
  &lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/15679091/35748228-2783-11e6-98ae-596b460c2d1a.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;No surprise, these two kinds of input data have the &lt;strong&gt;same&lt;/strong&gt; memory usage, which means that there is a huge waste when we pass &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data into original KMeans of scikit-learn because it requires same memory space as &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; data.&lt;/p&gt;

&lt;p&gt;To solve this problem, we can introduce Cython &lt;a href=&quot;(http://docs.cython.org/src/userguide/fusedtypes.html)&quot;&gt;fused types&lt;/a&gt; to avoid data copying.&lt;/p&gt;

&lt;h2 id=&quot;enhanced-results&quot;&gt;Enhanced Results&lt;/h2&gt;

&lt;p&gt;After PR &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/pull/6846&quot;&gt;#6846&lt;/a&gt;, now both &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#k-means&quot;&gt;KMeans&lt;/a&gt; and &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#mini-batch-k-means&quot;&gt;MiniBatchKMeans&lt;/a&gt; support fused types and can therefore use &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data as input directly.&lt;/p&gt;

&lt;p&gt;Below are the memory profiling results comparison:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Dense &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data
    &lt;ul&gt;
      &lt;li&gt;Before enhancement:
  &lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/15679091/35748228-2783-11e6-98ae-596b460c2d1a.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Dense &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data
    &lt;ul&gt;
      &lt;li&gt;After enhancement:
  &lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/15679092/374d2794-2783-11e6-8b95-7aac1347581c.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Sparse &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data
    &lt;ul&gt;
      &lt;li&gt;Before enhancement:
  &lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/16178924/79050080-3688-11e6-9381-1ced28bb5fc0.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Sparse &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data
    &lt;ul&gt;
      &lt;li&gt;After enhancement:
  &lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/16178743/806a0942-3683-11e6-8764-567762eb0577.png&quot; alt=&quot;&quot; /&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As one can see, introducing Cython fused types drastically reduces the memory usage of KMeans in scikit-learn, which can help us avoid unexpected memory waste.&lt;/p&gt;

&lt;p&gt;Note that in the sparse case, I directly transform the dense array used before into sparse array, which will result in higher memory usage since sparse format uses more space per nonzero value.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Both &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#k-means&quot;&gt;KMeans&lt;/a&gt; and &lt;a href=&quot;http://scikit-learn.org/stable/modules/clustering.html#mini-batch-k-means&quot;&gt;MiniBatchKMeans&lt;/a&gt; now support &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; input data in a memory-efficient way, go grab your huge dataset and feed them into KMeans of scikit-learn now!&lt;/p&gt;
</description>
        <pubDate>Tue, 28 Jun 2016 07:52:21 +0800</pubDate>
        <link>http://yclin.me/2016/06/KMeans</link>
        <guid isPermaLink="true">http://yclin.me/2016/06/KMeans</guid>
        
        
        <category>GSoC</category>
        
      </item>
    
      <item>
        <title>Difference between np.float64 &amp; np.float64_t</title>
        <description>&lt;p&gt;If you are a newcomer to Cython just like me, it is probably that you will be confused by the usage time of &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64_t&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Below, I’ll briefly introduce how these two types are fundamentally different, and generalize this concept to other datatypes as well.&lt;/p&gt;

&lt;p&gt;Before that, we need to know a bit of Cython.&lt;/p&gt;

&lt;h2 id=&quot;cimport-in-cython&quot;&gt;cimport in Cython&lt;/h2&gt;

&lt;p&gt;In Python, we use the &lt;code class=&quot;highlighter-rouge&quot;&gt;import&lt;/code&gt; statement to access functions, objects, and classes inside other &lt;em&gt;modules&lt;/em&gt; and &lt;em&gt;packages&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Cython also fully supports the &lt;code class=&quot;highlighter-rouge&quot;&gt;import&lt;/code&gt; statement, so it allows us to access Python objects defined in external Python modules.&lt;/p&gt;

&lt;p&gt;However, note that if above were the end of the story, Cython modules would not allow to access other Cython modules’ &lt;code class=&quot;highlighter-rouge&quot;&gt;cdef&lt;/code&gt; functions, &lt;code class=&quot;highlighter-rouge&quot;&gt;ctypedef&lt;/code&gt;s, or structs, and it would not allow C-level access to other extension types.&lt;/p&gt;

&lt;p&gt;To remedy this, Cython has a &lt;code class=&quot;highlighter-rouge&quot;&gt;cimport&lt;/code&gt; statement that provides &lt;strong&gt;compile time&lt;/strong&gt; access to C-level constructs, and it looks for these constructs’ declarations from separate Cython files called &lt;em&gt;definition files&lt;/em&gt;, which have a &lt;em&gt;.pxd&lt;/em&gt; extension and need to be created by us.&lt;/p&gt;

&lt;p&gt;In a &lt;em&gt;.pxd&lt;/em&gt; file, we can place the &lt;em&gt;declarations&lt;/em&gt; of C-level constructs that we wish to share, and only the &lt;em&gt;declarations&lt;/em&gt; here are cimportable. Also, since &lt;code class=&quot;highlighter-rouge&quot;&gt;some_file_name.pxd&lt;/code&gt; created by us have the same base name as the original file &lt;code class=&quot;highlighter-rouge&quot;&gt;some_file_name.pyx&lt;/code&gt;, they are treated as one namespace by Cython. Therefore, we need to modify &lt;code class=&quot;highlighter-rouge&quot;&gt;some_file_name.pyx&lt;/code&gt; in order to remove the repeat declarations in it.&lt;/p&gt;

&lt;p&gt;And after we have created the &lt;em&gt;.pxd&lt;/em&gt; file and clear the &lt;em&gt;.pyx&lt;/em&gt; file, now an external implementation file can access all C-level constructs inside &lt;em&gt;.pyx&lt;/em&gt; via the &lt;code class=&quot;highlighter-rouge&quot;&gt;cimport&lt;/code&gt; statement.&lt;/p&gt;

&lt;p&gt;Let’s take an real-world example to see how &lt;code class=&quot;highlighter-rouge&quot;&gt;cimport&lt;/code&gt; works!&lt;/p&gt;

&lt;h2 id=&quot;cimport-numpy-as-np&quot;&gt;cimport numpy as np&lt;/h2&gt;

&lt;p&gt;In some files of the well-known machine library scikit-learn (such as &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/blob/master/sklearn/utils/sparsefuncs_fast.pyx&quot;&gt;this one&lt;/a&gt;), you can find the following code snippet:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;cimport&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;np&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I remember I was stunned when I saw these lines for the first time, WHAT IS IT?&lt;/p&gt;

&lt;p&gt;Well, the good news is that we now know the basics of the &lt;code class=&quot;highlighter-rouge&quot;&gt;cimport&lt;/code&gt; statement, so we can figure it out step by step.&lt;/p&gt;

&lt;p&gt;First, since only the declarations in &lt;em&gt;.pxd&lt;/em&gt; file are cimportable, we have to identify which &lt;em&gt;.pxd&lt;/em&gt; file is Cython looking when executing &lt;code class=&quot;highlighter-rouge&quot;&gt;cimport numpy as np&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;After a bit of research, we should find that a file called &lt;a href=&quot;https://github.com/cython/cython/blob/970c2fc0e676ca22016e14147ada0edba937dc6b/Cython/Includes/numpy/__init__.pxd&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;__init__.pxd&lt;/code&gt;&lt;/a&gt; lies in the &lt;a href=&quot;https://github.com/cython/cython/tree/master/Cython/Includes/numpy&quot;&gt;&lt;strong&gt;numpy&lt;/strong&gt; folder&lt;/a&gt; under our Cython installation. An &lt;code class=&quot;highlighter-rouge&quot;&gt;__init__.pxd&lt;/code&gt; file can make Cython treat the directory as a package just like how &lt;code class=&quot;highlighter-rouge&quot;&gt;__init.py__&lt;/code&gt; works for Python (see &lt;a href=&quot;http://stackoverflow.com/questions/448271/what-is-init-py-for&quot;&gt;here&lt;/a&gt;). Therefore, in this case Cython will treat the &lt;strong&gt;numpy&lt;/strong&gt; folder as a package and give us access to Numpy’s C API defined in the &lt;a href=&quot;https://github.com/cython/cython/blob/970c2fc0e676ca22016e14147ada0edba937dc6b/Cython/Includes/numpy/__init__.pxd&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;__init__.pxd&lt;/code&gt;&lt;/a&gt; file during &lt;strong&gt;compile time&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;On the contrary, &lt;code class=&quot;highlighter-rouge&quot;&gt;import numpy as np&lt;/code&gt; will only give us access to Numpy’s pure-Python API and it occurs at &lt;strong&gt;runtime&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Note that here we use the same alias (i.e., &lt;code class=&quot;highlighter-rouge&quot;&gt;np&lt;/code&gt;) for both of the imported external packages, but thanks to the almighty Cython which will internally handles this ambiguity, we don’t not need to use different names.&lt;/p&gt;

&lt;h2 id=&quot;npfloat64-vs-npfloat64t&quot;&gt;np.float64 v.s np.float64_t&lt;/h2&gt;

&lt;p&gt;So here comes our main topic, what is the difference between &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64_t&lt;/code&gt;, and which should I use?&lt;/p&gt;

&lt;h4 id=&quot;npfloat64&quot;&gt;np.float64&lt;/h4&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; is a Python &lt;code class=&quot;highlighter-rouge&quot;&gt;type&lt;/code&gt; object that is defined at Python level to represent 64 bits float data, and it has common attributes such as &lt;code class=&quot;highlighter-rouge&quot;&gt;__name__&lt;/code&gt; that most of other Python objects have too. You can simply use the following code to verify it:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;np&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;__name__&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h4 id=&quot;npfloat64-1&quot;&gt;np.float64&lt;/h4&gt;

&lt;p&gt;In &lt;a href=&quot;https://github.com/cython/cython/blob/970c2fc0e676ca22016e14147ada0edba937dc6b/Cython/Includes/numpy/__init__.pxd&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;__init__.pxd&lt;/code&gt;&lt;/a&gt;, you can find the following lines:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ctypedef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;npy_float64&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ctypedef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;npy_float64&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;float64_t&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;So it is clear that &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64_t&lt;/code&gt; represents the type &lt;code class=&quot;highlighter-rouge&quot;&gt;double&lt;/code&gt; in C, and it is nowhere near as a Python object. Therefore, if you call &lt;code class=&quot;highlighter-rouge&quot;&gt;print np.float64_t&lt;/code&gt; in a &lt;em&gt;.pyx&lt;/em&gt; file, it will warn you the following message during compile time:
&lt;code class=&quot;highlighter-rouge&quot;&gt;&#39;float64_t&#39; is not a constant, variable or function identifier&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&quot;which-to-use&quot;&gt;Which to use?&lt;/h4&gt;

&lt;p&gt;Let’s take another simple example to illustrate the usage time between these two types:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;np&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;cimport&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;numpy&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt;
	
	&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;
	
	&lt;span class=&quot;o&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;k&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;We use &lt;code class=&quot;highlighter-rouge&quot;&gt;np.ndarray&lt;/code&gt; to declare the type of the object exposing the buffer interface, and place C data type inside the bracket for the array elements. So, we should make sure we use &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64_t&lt;/code&gt; here to specify the element’s data type .&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;To initialize the Numpy buffer we just declared, we can create an array object at Python level and assign it to the Numpy buffer. In this case, we should use &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; since we are not declaring C type variable.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Of course, The same concept can be generalized to other data types (e.g., &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int32&lt;/code&gt; v.s &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int32_t&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int64&lt;/code&gt; v.s &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int_64_t&lt;/code&gt;, etc.)&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;After working on Cython for a month, I found debugging in Cython is both hard and frustrated because the documents is not really thorough.&lt;/p&gt;

&lt;p&gt;Consequently, I hope this blog post can safe your effort by helping you clarify the difference between data types defined in Cython and Python.&lt;/p&gt;

&lt;p&gt;In the future, I will also document more of my findings about Cython during my GSoC.&lt;/p&gt;
</description>
        <pubDate>Thu, 09 Jun 2016 07:52:21 +0800</pubDate>
        <link>http://yclin.me/2016/06/difference-between-float64-and-float64_t</link>
        <guid isPermaLink="true">http://yclin.me/2016/06/difference-between-float64-and-float64_t</guid>
        
        
        <category>GSoC</category>
        
      </item>
    
      <item>
        <title>scikit-learn Sparse Utils Now Support Fused Types</title>
        <description>&lt;p&gt;Dealing with sparse data is fairly common when we are anlyzing large datasets. However, sparse function utilities in scikit-learn only support &lt;code class=&quot;highlighter-rouge&quot;&gt;float64&lt;/code&gt; currently and will therefore implicitly convert other input data types, e.g., &lt;code class=&quot;highlighter-rouge&quot;&gt;float32&lt;/code&gt;, into &lt;code class=&quot;highlighter-rouge&quot;&gt;float64&lt;/code&gt;, which may cause unexpected memory error. Since &lt;a href=&quot;http://docs.cython.org/src/userguide/fusedtypes.html&quot;&gt;Cython fused types&lt;/a&gt; allow us to have one type definition that can refer to multiple types, we can solve potential memory wasting issue by substituting &lt;code class=&quot;highlighter-rouge&quot;&gt;float64&lt;/code&gt; with Cython fused types.&lt;/p&gt;

&lt;p&gt;Below, I’ll briefly introduce sparse function utilities in scikit-learn and describe the work I’ve done to enhance it during GSoC.&lt;/p&gt;

&lt;h2 id=&quot;sparse-function-utilities&quot;&gt;Sparse Function Utilities&lt;/h2&gt;

&lt;p&gt;In scikit-learn, sparse data is often represented as &lt;code class=&quot;highlighter-rouge&quot;&gt;scipy.sparse.csr_matrix&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;scipy.sparse.csc_matrix&lt;/code&gt;. However, these two matrices do not provide built-in methods to calculate important statistics such as &lt;em&gt;L2 norm&lt;/em&gt; and &lt;em&gt;variance&lt;/em&gt;, which are useful when we are playing with data. Therefore, scikit-learn leverages on &lt;code class=&quot;highlighter-rouge&quot;&gt;sparsefuncs_fast.pyx&lt;/code&gt; which defines some helper methods for sparse matrices to handle sparse data more conveniently throughout the project.&lt;/p&gt;

&lt;h2 id=&quot;memory-wasting-issue&quot;&gt;Memory Wasting Issue&lt;/h2&gt;

&lt;p&gt;However, original implementation of sparse function utilities in scikit-learn is not memory-efficient.&lt;/p&gt;

&lt;p&gt;Let’s take a simple function which do not use Cython fused types and will calculate &lt;em&gt;L2 norm&lt;/em&gt; of a CSR matrix &lt;code class=&quot;highlighter-rouge&quot;&gt;X&lt;/code&gt; as example:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;csr_row_norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;L2 norm of each row in CSR matrix X.&quot;&quot;&quot;&lt;/span&gt;
    
    &lt;span class=&quot;c&quot;&gt;# 1&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_features&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;npy_intp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt;
	 
	 &lt;span class=&quot;c&quot;&gt;# 2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    
    &lt;span class=&quot;c&quot;&gt;# 3&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# Warning: might copy!&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# 4&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt;
	 
	 &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sqrt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	 
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Declare Cython’s &lt;strong&gt;static-typed&lt;/strong&gt; (in contrast to Python’s &lt;strong&gt;dynamic-typed&lt;/strong&gt;) variables to store attributes of the input CSR matrix X since static-typed variables can accelerate the computation a lot.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Initialize &lt;code class=&quot;highlighter-rouge&quot;&gt;norms&lt;/code&gt; with 0s.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Since we’ve already used &lt;code class=&quot;highlighter-rouge&quot;&gt;cdef&lt;/code&gt; to declare &lt;code class=&quot;highlighter-rouge&quot;&gt;data&lt;/code&gt; as a &lt;code class=&quot;highlighter-rouge&quot;&gt;np.ndarray&lt;/code&gt; which contains &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64_t&lt;/code&gt; element in step 1, data of X need to be converted into type &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; if it belongs to other data types.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Calculate the squared sum of each row and then take squared root of it to get &lt;em&gt;L2 norm&lt;/em&gt;.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;As illustrated above, we can see that &lt;strong&gt;STEP 3 IS DANGEROUS&lt;/strong&gt; because converting type of data may implicitly copy the the data and then &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/issues/5776&quot;&gt;cause memory error&lt;/a&gt; unexpectedly. To see how it will affect the memory space, we can use &lt;a href=&quot;https://github.com/fabianp/memory_profiler&quot;&gt;memory_profiler&lt;/a&gt; to monitor memory usage.&lt;/p&gt;

&lt;p&gt;Here is the result of memory profiling if we pass a &lt;code class=&quot;highlighter-rouge&quot;&gt;scipy.sparse.csr_matrix&lt;/code&gt; with &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; element into our example function:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../../assets/2016-05-29/no_fused_types.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It is abvious that memory usage increase dramatically because step 3 copies the data so as to convert it from &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To solve this problem, we can introduce Cython fused types to avoid data copying. But firstly, let’s take a brief look at Cython fused types.&lt;/p&gt;

&lt;h2 id=&quot;cython-fused-types&quot;&gt;Cython Fused Types&lt;/h2&gt;

&lt;p&gt;Here is &lt;a href=&quot;http://docs.cython.org/src/userguide/fusedtypes.html&quot;&gt;official page&lt;/a&gt;’s clear introduction for fused types:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Fused types allow you to have one type definition that can refer to multiple types. This allows you to write a single static-typed cython algorithm that can operate on values of multiple types. Thus fused types allow generic programming and are akin to templates in C++ or generics in languages like Java / C#.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Note that Cython fused types are specialized at &lt;strong&gt;compile time&lt;/strong&gt;, and are &lt;strong&gt;constant&lt;/strong&gt; for a particular function invocation.&lt;/p&gt;

&lt;p&gt;By adopting Cython fused types, our function can accept multiple types and therefore doesn’t need to do datatype conversion.&lt;/p&gt;

&lt;h2 id=&quot;common-pitfalls&quot;&gt;Common Pitfalls&lt;/h2&gt;

&lt;p&gt;Intuitively, in order to integrate Cython fused types to solve the memory issue described above, we will delete step 3 and change step 1 in our function as follows:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;c&quot;&gt;# 1&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_features&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        
        &lt;span class=&quot;c&quot;&gt;# Change type from np.float64_t to floating&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt; 
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; 
        
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;npy_intp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;However, above changes will cause Cython compile error &lt;code class=&quot;highlighter-rouge&quot;&gt;Invalid use of fused types, type cannot be specialized&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;It seems that Cython doesn’t allow us to declare fused types variable and then assign value to it within a function &lt;strong&gt;if this function doesn’t accept any argument that has type involves the same fused types&lt;/strong&gt;. Hence, we need to introduce a implementation trick here.&lt;/p&gt;

&lt;h2 id=&quot;enhanced-implementation&quot;&gt;Enhanced Implementation&lt;/h2&gt;

&lt;p&gt;The trick I used here is to define a wrapper function and make its underlying implementation function accept fused types arguments. The reason behind this is mentioned above:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;If a function accepts some argument that has a particular fused type&lt;/strong&gt;, it can use &lt;code class=&quot;highlighter-rouge&quot;&gt;cdef&lt;/code&gt; to declare and init variable with that particular fused type within its scope.&lt;/p&gt;

&lt;p&gt;Code of enhanced implementation is showed below:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Wrapper function&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;csr_row_norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;&quot;&quot;L2 norm of each row in CSR matrix X.&quot;&quot;&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_csr_row_norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Underlying implementation function&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;_csr_row_norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;floating&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                   &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                   &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_indices&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                   &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cdef&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n_features&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DOUBLE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndim&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;npy_intp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;zeros&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;np&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;float64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n_samples&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;0.0&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;j&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;X_indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_indptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]):&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X_data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;j&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum_&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;norms&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Finally, to verify our enhancement, here is the result of memory profiling if we pass a &lt;code class=&quot;highlighter-rouge&quot;&gt;scipy.sparse.csr_matrix&lt;/code&gt; with &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; element into our enhamced function:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../../assets/2016-05-29/fused_types.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Cool! As what figure shows, our function no longer copy the data anymore.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;All of the functions in &lt;code class=&quot;highlighter-rouge&quot;&gt;sparsefuncs_fast.pyx&lt;/code&gt; now support Cython fused types! Great thanks to all of the reviewers and their useful opinions.&lt;/p&gt;

&lt;p&gt;In the next few weeks, my goal is to work on clustering algorithms such as KMeans in scikit-learn so as to make it also support Cython fused types.&lt;/p&gt;
</description>
        <pubDate>Sat, 28 May 2016 07:52:21 +0800</pubDate>
        <link>http://yclin.me/2016/05/sparse-func-utils</link>
        <guid isPermaLink="true">http://yclin.me/2016/05/sparse-func-utils</guid>
        
        
        <category>GSoC</category>
        
      </item>
    
      <item>
        <title>Hello Google Summer of Code!</title>
        <description>&lt;p&gt;&lt;img src=&quot;https://musescore.org/sites/musescore.org/files/Capture%20d&#39;e%CC%81cran%202016-03-01%2009.48.11.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In this summer, I will participate in &lt;a href=&quot;https://summerofcode.withgoogle.com/&quot;&gt;Google Summer of Code&lt;/a&gt; (GSoC for short), a program offers student developers stipends to write code for various open source projects. My proposal for GSoC, &lt;a href=&quot;https://summerofcode.withgoogle.com/projects/#5336489219063808&quot;&gt;Adding fused types to Cython files&lt;/a&gt;, which aims to enhance the popular machine learning library &lt;a href=&quot;http://scikit-learn.org/&quot;&gt;scikit-learn&lt;/a&gt; has been accepted and will be supervised by two mentors from scikit-learn community: &lt;a href=&quot;https://github.com/jnothman&quot;&gt;Jnothman&lt;/a&gt; and &lt;a href=&quot;https://github.com/MechCoder&quot;&gt;Mechcoder&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Below, I’ll briefly describe the work I’d like to achieve during GSoC.&lt;/p&gt;

&lt;h2 id=&quot;proposal-abstract&quot;&gt;Proposal Abstract&lt;/h2&gt;

&lt;p&gt;The current implementation of many algorithms in scikit-learn, such as Stochastic Gradient Descent, Coordinate Descent, etc. only allow input with &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int64&lt;/code&gt; dtypes due to the adoption of &lt;a href=&quot;http://docs.cython.org/src/userguide/fusedtypes.html&quot;&gt;Cython fused types&lt;/a&gt; may result in explosion of the generated C code. However, since scikit-learn has removed Cython files from the repo and re-generate them from every build, it provides a good chance to refactor some of the “.pyx” files by introducing Cython fused types. This will allow those algorithms to support &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int32&lt;/code&gt; dtypes data, which is currently casted into &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;np.int64&lt;/code&gt; respectively, and therefore reduce the waste of memory space.&lt;/p&gt;

&lt;p&gt;You can find the detailed version of my proposal &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/wiki/GSoC-2016-Proposal:-Adding-fused-types-to-Cython-files&quot;&gt;here&lt;/a&gt;!&lt;/p&gt;

&lt;h2 id=&quot;example&quot;&gt;Example&lt;/h2&gt;

&lt;p&gt;Here, I’ll use an example to illustrate how Cython fused types can benefit the whole project.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mean_variance&lt;/code&gt; function in scikit-learn, like some algorithms I mentioned in my proposal abstract above, will explicitly cast &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data into &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float64&lt;/code&gt; before this &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/pull/6593&quot;&gt;pull request&lt;/a&gt;, which yields waste of memory. However, after we introduce Cython fused types into this function’s implementation, it can now accept &lt;code class=&quot;highlighter-rouge&quot;&gt;np.float32&lt;/code&gt; data directly.&lt;/p&gt;

&lt;p&gt;Results of this enhancement can be visualized via memory profiling figures showed below:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Memory usage &lt;strong&gt;before&lt;/strong&gt; using fused types&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/14371491/dc5a77fc-fd6a-11e5-9d5c-42d17799667f.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Memory usage &lt;strong&gt;after&lt;/strong&gt; using fused types&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;https://cloud.githubusercontent.com/assets/7057863/14371492/dc5e585e-fd6a-11e5-8633-5fb68a3d02f9.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;As one can see, memory usage surrounded by the bracket drastically decrease.&lt;/p&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;I believe that scikit-learn’s memory efficiency can be hugely improved after I add fused types into existing Cython files in the project.&lt;/p&gt;

&lt;p&gt;On the other hand, great thanks to scikit-learn community for giving me this golden opportunity to work on an open source projects I use every day.&lt;/p&gt;

&lt;p&gt;Really Looking forward to this productive summer!&lt;/p&gt;
</description>
        <pubDate>Tue, 03 May 2016 07:52:21 +0800</pubDate>
        <link>http://yclin.me/2016/05/hello-google-summer-of-code</link>
        <guid isPermaLink="true">http://yclin.me/2016/05/hello-google-summer-of-code</guid>
        
        
        <category>GSoc</category>
        
      </item>
    
  </channel>
</rss>
